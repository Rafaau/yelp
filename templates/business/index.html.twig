{% extends 'base.html.twig' %}
{% block body %}
    <div class="relative top-28 mb-28 flex {{ imageCount >= 3 ? 'h-[450px]' : 'h-[250px]' }} brightness-50">
        {% if imageCount >= 3 %}
            {% for review in business.reviews %}
                {% for image in review.images %}
                    <img 
                        class="object-cover"
                        src="{{ asset('' ~ image) }}">
                {% endfor %}
            {% endfor %}
        {% endif %}
    </div>
    <div class="absolute z-10 {{ imageCount >= 3 ? 'text-zinc-100 top-[22rem] px-16' : 'text-zinc-900 top-40 px-10' }} xl:px-56">
        <p class="text-5xl font-black">{{ business.name }}</p>
        <div class="flex items-center my-4">
            {% set totalStars = 0 %}
            {% for review in business.reviews %}
                {% set totalStars = totalStars + review.stars %}
            {% endfor %}
            {% set avgStars = totalStars / business.reviews|length %}

            {% for i in 1..5 %}
                {% set color = 
                    avgStars >= 9 ? 'rgba(251,67,60,1)' :
                    avgStars >= 7 ? 'rgba(255,100,61,1)' :
                    avgStars >= 5 ? 'rgba(255,135,66,1)' :
                    avgStars >= 3 ? 'rgba(255,173,72,1)' :
                    avgStars >= 1 ? 'rgba(255,204,75,1)' : 
                    '#BBBAC0'
                %}
                <svg width="30" height="30" viewBox="0 0 20 20" class="mr-1">
                    <path 
                        fill="{{ avgStars >= i * 2 - 1 ? color :
                                '#BBBAC0' }}" 
                        opacity="1" d="M0 4C0 1.79086 1.79086 0 4 0H10V20H4C1.79086 20 0 18.2091 0 16V4Z">
                    </path>
                    <path 
                        fill="{{ avgStars >= i * 2 ? color :
                                '#BBBAC0' }}" 
                        opacity="1" d="M20 4C20 1.79086 18.2091 0 16 0H10V20H16C18.2091 20 20 18.2091 20 16V4Z">
                    </path>
                    <path fill="white" fill-rule="evenodd" clip-rule="evenodd" d="M10 13.3736L12.5949 14.7111C12.7378 14.7848 12.9006 14.8106 13.0593 14.7847C13.4681 14.718 13.7454 14.3325 13.6787 13.9237L13.2085 11.0425L15.2824 8.98796C15.3967 8.8748 15.4715 8.72792 15.4959 8.569C15.5588 8.15958 15.2779 7.77672 14.8685 7.71384L11.983 7.2707L10.6699 4.66338C10.5975 4.51978 10.481 4.40322 10.3374 4.33089C9.96742 4.14458 9.51648 4.29344 9.33017 4.66338L8.01705 7.2707L5.13157 7.71384C4.97265 7.73825 4.82577 7.81309 4.71261 7.92731C4.42109 8.22158 4.42332 8.69645 4.71759 8.98796L6.79152 11.0425L6.32131 13.9237C6.29541 14.0824 6.3212 14.2452 6.39486 14.3881C6.58464 14.7563 7.03696 14.9009 7.40514 14.7111L10 13.3736Z"></path>
                </svg>
            {% endfor %}
            <span class="ml-3 font-semibold hover:underline cursor-pointer">
                {{ business.reviews|length }} reviews
            </span>
        </div>
        <div class="flex items-center font-semibold my-1">
            {% if business.owner is not null %}
                <i class="fa-solid fa-circle-check text-blue-400 mr-1 text-sm"></i>
                <span class="text-blue-400 mr-2">
                    Claimed
                </span>
            {% else %}
                <span class="mr-1">
                    Unclaimed
                </span>
                <i class="fa-solid fa-circle-exclamation mx-2 text-sm"></i>
            {% endif %}
            <span class="mr-2">•</span>           
            {% for i in 1..business.expensiveness %}
                <i class="fa-solid fa-dollar-sign"></i>
            {% endfor %}
            <span class="ml-2">•</span>  
            <a 
                href="{{ path('search', { 'cflt': business.categories[1].name|lower, 'find_loc': location }) }}" 
                class="ml-2 hover:underline cursor-pointer">
                {{ business.categories[1].name }}
            </a>
            <span class="bg-zinc-400 bg-opacity-30 px-2 ml-3 text-sm py-[0.125rem] rounded cursor-pointer hover:bg-opacity-50 transition-[0.5] font-thin">
                Edit
            </span>
        </div>
        {% set currentDay = "now"|date("D") %}
        {% set currentTime = "now"|date("H:i") %}
        {% set openHours = business.hours[currentDay]|split(" - ") %}
        {% set openingTime = openHours[0]|date("H:i") %}
        {% set closingTime = openHours[1]|date("H:i") %}

        {% if currentTime >= openingTime and currentTime <= closingTime %}
            <span class="text-green-600 font-semibold text-lg">
                Open
            </span>
        {% else %}
            <span class="text-red-400 font-semibold text-lg">
                Closed
            </span>
        {% endif %}
        <span class="font-semibold ml-2">
            {{ openingTime }} - {{ closingTime }}
        </span>
        <span class="bg-zinc-400 bg-opacity-30 px-2 ml-2 text-sm py-[0.125rem] rounded cursor-pointer hover:bg-opacity-50 transition-[0.5]">
            See hours
        </span>
    </div>
    <div class="flex max-w-[1300px] mx-auto px-10">
        <div class="py-4 pr-10 w-[65%]">
            <p class="text-sm text-zinc-600">
                <a 
                    class="hover:underline cursor-pointer"
                    href="{{ path('search', { 'cflt': business.categories[0].name|lower, 'find_loc': location }) }}" >
                    {{ business.categories[0].name }}
                </a>
                <i class="fa-solid fa-chevron-right mx-2 text-xs"></i>
                <a 
                    class="hover:underline cursor-pointer"
                    href="{{ path('search', { 'cflt': business.categories[1].name|lower, 'find_loc': location }) }}" >
                    {{ business.categories[1].name }}
                </a>
                <i class="fa-solid fa-chevron-right mx-2 text-xs"></i>       
                {{ business.name }}
            </p>
            <div class="flex my-8">
                <button class="bg-red-600 text-zinc-100 px-4 py-2 rounded font-semibold">
                    <i class="fa-regular fa-star mr-2"></i>
                    Write a review
                </button>
                <button class="py-2 px-4 border border-zinc-400 rounded ml-2 hover:bg-zinc-400 hover:bg-opacity-30 transition-[0.5] font-semibold">
                    <i class="fa-solid fa-camera-retro mr-2"></i>
                    Add Photo
                </button>
                <button class="py-2 px-4 border border-zinc-400 rounded ml-2 hover:bg-zinc-400 hover:bg-opacity-30 transition-[0.5] font-semibold">
                    <i class="fa-regular fa-share-from-square"></i>
                    Share
                </button>
                <button class="py-2 px-4 border border-zinc-400 rounded ml-2 hover:bg-zinc-400 hover:bg-opacity-30 transition-[0.5] font-semibold">
                    <i class="fa-regular fa-bookmark"></i>
                    Save
                </button>
            </div>
            <div class="border-b border-t py-8">
                <span class="font-black text-xl">
                    Location & Hours
                    <div class="flex mt-6">
                        <div>
                            <img src="https://maps.googleapis.com/maps/api/staticmap?size=315x150&sensor=false&client=gme-yelp&language=en&scale=1&zoom=15&center=51.511835%2C-0.122708&markers=scale%3A1%7Cicon%3Ahttps%3A%2F%2Fyelp-images.s3.amazonaws.com%2Fassets%2Fmap-markers%2Fannotation_32x43.png%7C51.511835%2C-0.122708&signature=ghss--MrHd30bDdO0JRyjz1dY6c="/>
                            <div class="flex mt-4">
                                <div>
                                    <p class="font-bold text-cyan-600 block text-sm">
                                        {{ business.address }}
                                    </p>
                                    <p class="font-bold text-sm">
                                        {{ business.location }}
                                    </p>
                                </div>
                                <button class="py-2 px-4 border border-zinc-400 rounded ml-auto hover:bg-zinc-400 hover:bg-opacity-30 transition-[0.5] font-semibold text-sm">
                                    Get directions
                                </button>
                            </div>
                        </div>
                        <div class="font-thin text-base ml-8 [&>p]:my-1">
                            {% set currentDay = "now"|date('D') %}
                            {% set currentTime = "now"|date('H:i')|date_modify("+0 seconds") %}
                            {% for day, hours in business.hours %}
                                {% set openCloseHours = hours|split(' - ') %}
                                {% set openHour = openCloseHours[0]|date('H:i') %}
                                {% set closeHour = openCloseHours[1]|date('H:i') %}
                                
                                {% if day == currentDay %}
                                    {% if currentTime >= openHour and currentTime <= closeHour %}
                                        <p>
                                            <div class="w-12 inline-block">{{ day }}</div> 
                                            {{ hours }}  
                                            <span class="text-green-600 ml-4">
                                                Open now
                                            </span>
                                        </p>
                                    {% else %}
                                        <p>
                                            <div class="w-12 inline-block">
                                                {{ day }}
                                            </div> 
                                            {{ hours }}  
                                            <span class="text-red-600 ml-4">
                                                Closed now
                                            </span>
                                        </p>
                                    {% endif %}
                                {% else %}
                                    <p>
                                        <div class="w-12 inline-block">
                                            {{ day }}
                                        </div>   
                                        {{ hours }}
                                    </p>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </span>
            </div>
                {% if business.owner is not null or business.description is not null %}
                    <div class="my-8 pb-8 border-b">
                        <span class="font-black text-xl my-3">
                            About the Business
                        </span>
                        <div class="flex mt-6 items-center">
                            <img src="{{ asset('build/images/avatar_default.19e0a8ff.jpg') }}" class="w-12 h-12 rounded-full mr-3 border">
                            <div>
                                <p class="font-semibold">
                                    {{ business.owner }}
                                </p>
                                <p class="text-sm text-zinc-600">
                                    Business Owner
                                </p>
                            </div>
                        </div>
                        <p class="mt-6 font-roboto-light">
                            {{ business.description }}
                        </p>
                    </div>
                {% endif %}
            <div class="my-8">
                <span class="font-black text-xl">
                    Recommended reviews
                </span>
                {% for review in business.reviews %}
                    <div class="mt-6 mb-10">
                        <div class="flex">
                            <img src="{{ asset('' ~ review.user.userImage) }}" class="w-[4.5rem] h-[4.5rem] rounded-full mr-3 border">
                            <div>
                                <p class="font-semibold mt-[0.125rem]">
                                    {{ review.user.username }}
                                </p>
                                <p class="text-sm font-roboto-light">
                                    {{ review.user.address }}
                                </p>
                                <div class="flex items-center text-zinc-600 text-sm mt-1">
                                    <i class="fa-solid fa-users-rectangle text-xs"></i>
                                    <span class="mx-1">
                                        {{ review.user.friends|length }}
                                    </span>
                                    <i class="fa-regular fa-message text-xs ml-2"></i>
                                    <span class="mx-1">
                                        {{ review.user.reviews|length }}
                                    </span>
                                    <i class="fa-regular fa-images text-xs ml-2"></i>
                                    <span class="mx-1">
                                        {{ review.user.friends|length }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center py-4">
                            {% for i in 1..5 %}
                                {% set color = 
                                    review.stars >= 9 ? 'rgba(251,67,60,1)' :
                                    review.stars >= 7 ? 'rgba(255,100,61,1)' :
                                    review.stars >= 5 ? 'rgba(255,135,66,1)' :
                                    review.stars >= 3 ? 'rgba(255,173,72,1)' :
                                    review.stars >= 1 ? 'rgba(255,204,75,1)' : 
                                    '#BBBAC0'
                                %}
                                <svg width="20" height="20" viewBox="0 0 20 20" class="mr-1">
                                    <path 
                                        fill="{{ review.stars >= i * 2 - 1 ? color :
                                                '#BBBAC0' }}" 
                                        opacity="1" d="M0 4C0 1.79086 1.79086 0 4 0H10V20H4C1.79086 20 0 18.2091 0 16V4Z">
                                    </path>
                                    <path 
                                        fill="{{ review.stars >= i * 2 ? color :
                                                '#BBBAC0' }}" 
                                        opacity="1" d="M20 4C20 1.79086 18.2091 0 16 0H10V20H16C18.2091 20 20 18.2091 20 16V4Z">
                                    </path>
                                    <path fill="white" fill-rule="evenodd" clip-rule="evenodd" d="M10 13.3736L12.5949 14.7111C12.7378 14.7848 12.9006 14.8106 13.0593 14.7847C13.4681 14.718 13.7454 14.3325 13.6787 13.9237L13.2085 11.0425L15.2824 8.98796C15.3967 8.8748 15.4715 8.72792 15.4959 8.569C15.5588 8.15958 15.2779 7.77672 14.8685 7.71384L11.983 7.2707L10.6699 4.66338C10.5975 4.51978 10.481 4.40322 10.3374 4.33089C9.96742 4.14458 9.51648 4.29344 9.33017 4.66338L8.01705 7.2707L5.13157 7.71384C4.97265 7.73825 4.82577 7.81309 4.71261 7.92731C4.42109 8.22158 4.42332 8.69645 4.71759 8.98796L6.79152 11.0425L6.32131 13.9237C6.29541 14.0824 6.3212 14.2452 6.39486 14.3881C6.58464 14.7563 7.03696 14.9009 7.40514 14.7111L10 13.3736Z"></path>
                                </svg>
                            {% endfor %}
                            <span class="text-zinc-600 ml-3 font-roboto-light">
                                {{ review.postDate|date("d/m/Y") }}
                            </span>
                        </div>
                        {% if review.images|length %}
                            <p class="font-semibold text-xs text-zinc-700 mb-4">
                                <i class="fa-solid fa-camera-retro text-xs mr-2"></i>
                                {{ review.images|length }} {{ review.images|length > 1 ? 'photos' : 'photo' }}
                            </p>
                        {% endif %}
                        <div class="font-roboto-light">
                            {{ review.content|nl2br }}
                        </div>
                        {% if review.images|length %}
                        <div class="flex h-36 my-6 space-x-4">
                            {% for image in review.images %}
                                <img 
                                    class="object-cover h-full w-1/3 rounded-md"
                                    src="{{ asset('' ~ image) }}">
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
        <div class="sticky border px-4 py-4 w-96 h-40 top-6 mb-6 mt-12 ml-auto">
            <a 
                href="{{ business.website }}"
                class="font-bold text-cyan-700 border-b pb-2 flex cursor-pointer">
                {{ business.website }}
                <i class="fa-solid fa-arrow-up-right-from-square ml-auto text-zinc-800 text-2xl"></i>
            </a>
            <p class="border-b py-2 flex">
                {{ business.phoneNumber }}
                <i class="fa-solid fa-phone-volume ml-auto mt-1 text-zinc-800 text-2xl"></i>
            </p>
            <div class="flex items-center pt-2">
                <div>
                    <p class="font-bold text-cyan-700">
                        Get Directions
                    </p>
                    <p class="text-zinc-500">
                        {{ business.address }} {{ business.location }}
                    </p>        
                </div>
                <i class="fa-solid fa-diamond-turn-right ml-auto text-zinc-800 text-2xl"></i>
            </div>
        </div>
    </div>
{% endblock %}
